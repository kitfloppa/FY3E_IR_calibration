Версия 1.0 от 20.04.2023
	Начальный текст.
Версия 1.1 от 27.04.2023
	Исправлена информация о размерах DATA1 и DATA2.
Версия 1.2 от 03.05.2023
	Добавлена информация о структурах данных DATA2, DATA3, DATA4 и DATA5.

Введение.

В этом файле рассмотрена в общих чертах структура файла транспортного уровня семейства
радиометров MERSI спутника FY3E. Как правило, такой файл имеет название типа
Y3E_08534_230226070855_7860R_MERSI.DAT, где первая группа символов, по-видимому,
обозначает название спутника, вторая группа - неизвестна (возможно, номер витка),
третья группа - дата и время приема сеанса в формате YYMMDDHHMMSS, хотя неизвестно,
какое время UTC или что-то китайское, четвертая группа цифра - неизвестна (возможно,
частота передачи в МГц и поляризация), далее обозначения радиометра MERSI. Расширение
файла *.dat говорит о том, что это сырые данные уровня L0, то есть получены после
базовых декодировок битового потока, исправляющих ошибки, Витерби и Рида-Соломона.

Если бы данные были до декодировки Рида-Соломона, весь файл состоял бы из кадров
размером в 1Кб с синхросерией 0x1ACFFC1D. Поскольку таких кадров нет, декодировка
РС уже произведена и это уже следующий, транспортный уровень. Об этом говорит и
тот факт, что кроме заголовка файла, записанного, по-видимому, приемной станцией,
весь файл состоит из транспортных пакетов, имеющих 10-байтовый заголовок.
В стандартной 7-уровневой модели передачи данных заголовок пакета транспортного
уровня имеет стандартный размер 8192 байта и заголовок, содержащий дату и время
пакета по бортовым часам, тип пакета, обозначающий либо содержащиеся внутри данные,
либо номер инструмента, номер пакета, как правило, циклически меняющийся от 0 до 4095
и предназначенный для детектирования пропавших пакетов и другую синхроинформацию,
предназначенную для идентификации начала пакета в транспортном потоке.

К сожалению, в транспортном потоке данных MERSI FY3E вся эта стройная система
нарушена. Во-первых транспортные пакеты, содержащиеся в вышеупомянутом файле,
имеют разную длину, а во-вторых, заголовок транспортного пакета, состоящий из
10 байт, не содержит никакой информации, кроме 9 нулевых байт и последнего байта,
имеющего всегда содержимое 0x64. Вероятно, различная длина пакетов транспортного
уровня обусловлена самим содержанием данных MERSI FY3E и нежеланием разработчиков
подгонять свои специфические данные под стандартные размеры, но вот отсутствие
каких бы то ни было данных в заголовке пакетов - это, с моей точки зрения,
существенный дефект передаваемых данных. Отсутствие номеров и времени не позволяет
контролировать gap'ы, то есть потери пакетов, а отсутствие типа пакетов не позволяет
определить, какого рода данные находятся в пакете, и отличить один пакет от другого.

С другой стороны, дефекты такого рода позволяют предположить, что для разработчиков
MERSI FY3E было неважно, содержится ли в заголовке пакета какая-либо информация,
и именно поэтому она не была туда занесена. Например, передаваемая информация
является жестко структурированной и позиционной, то есть тип информации жестко
зависит от той позиции, какую эта информация занимает в общем потоке данных, и если
предположить, что пакеты вообще не теряются, то тогда и номера пакетов, и время,
и тип данных уже не нужны. Если в передаваемом транспортном потоке нет потери пакетов
и каждый тип данных при передаче в потоке всегда имеет одно и то же место, тогда
программам верхнего уровня, обрабатыющим транспортный поток, достаточно "зацепиться"
в потоке за какой-то репер и дальше, начиная от этой точки, все данные будут
определены автоматически по смещению от этой точки, аналогично элементам массива.

Такая система передачи данных, применяемая китайцами, является для спутниковых данных
неким оригинальным и нестандартным нововведением. Мало того, что такая система не
поддерживается стандартной моделью передачи данных, она ни разу не применялась,
насколько мне известно, никакими другими космическими агентствами. Самое правильное
с точки зрения стандартизации, японское космическое агентство JMA, передающее данные
HRIT, буквально и досконально придерживается стандартной модели. Там, в японских
передаваемых данных, сохранены все рекомендованные в стандарте коэффициенты, полиномы,
параметры Витерби и Рида-Соломона, длины транспортных пакетов и структуры заголовков.
После анализа японских данных можно заново восстановить всю документацию по стандартной
модели, настолько точно она там воспроизведена. Европейское космическое агентство ESA,
отвечающее за разработку передачи данных METOP, тоже выполнило всю работу на стандартном
уровне. Как и рекомендовано в стандартной модели, все пакеты транспортного уровня
одинаковой длины поступают со спутника в произвольном порядке, зависящем от того, какие
данные были получены раньше. Наличие на спутнике нескольких сканеров, работающих в
разном темпе, не позволяет дожидаться, пока не будут получены все данные для формирования
какого-нибудь блока данных. Вместо этого, после получения на спутнике данных одного типа
они сразу же начинают передаваться в виде транспортных пакетов, снабженных временем,
номером пакета и типом данных. Если в процессе передачи одного типа данных готовы данные
другого типа, они тут же вставляются в общий передаваемый поток. Таким образом, все
данные разных типов от разных инструментов оказываются перемешанными в общем транспортном
потоке, как и рекомендовано в стандартной модели. Отметим, что несмотря на то, что
на спутниках METOP стоит американский сканер AVHRR, как и на спутниках NOAA, передача
данных METOP разительно отличается от старой системы передачи NOAA, где все данные
вставлялись в один кадр фиксированной длины и весь принятый файл представлял из себя
строго последовательный поток таких кадров. Таким образом, получается, что при передаче
данных MERSI FY3E Китайское Метеорологическое Агентство отказалось от нормальной
стандартной модели и перешло на передачу данных в стиле старого недоброго NOAA.

1. Структура файла *MERSI.DAT

Как уже упоминалось во Введении, файл *MERSI.DAT состоит из заголовка, записываемого
приемной станцией и следующего за ним транспортного потока. В свою очередь, транспортный
поток состоит из некоторого количества транспортных пакетов. Каждый транспортный пакет
имеет заголовок (который может рассматриваться как синхросерия для поиска начала пакета)
и содержащиеся в нем данные.

Выше во Введении было сделано предположение, что отсутствие в заголовке транспортного пакета
информации о номере пакета, типе пакета и времени пакета говорит о том, что такая информация
не нужна, если пакеты объединены в более общие образования с жесткой структурой. Визуализация
данных MERSI показала, что так оно и есть.

Структуризация данных MERSI видна уже на уровне длин пакетов. Ниже приведен фрагмент распечатки
структуры данных файла.

Bits:  0 offs: 001452C2 ( 3362 ) m:      0
Bits:  0 offs: 001476CC ( 3362 ) m:      1 d:   9226
Bits:  0 offs: 00149AD6 ( 3362 ) m:      2 d:   9226
Bits:  0 offs: 0014BEE0 ( 3362 ) m:      3 d:   9226
Bits:  0 offs: 0014E2EA ( 3362 ) m:      4 d:   9226
Bits:  0 offs: 001506F4 ( 3362 ) m:      5 d:   9226
...
Bits:  0 offs: 00231ADC ( 3362 ) m:    105 d:   9226
Bits:  0 offs: 00233EE6 ( 3362 ) m:    106 d:   9226
Bits:  0 offs: 0023651A ( 3916 ) m:    107 d:   9780
Bits:  0 offs: 0023CA64 ( 2168 ) m:    108 d:  25930
Bits:  0 offs: 00240DEE ( 1006 ) m:    109 d:  17290
Bits:  0 offs: 00242FB8 (  430 ) m:    110 d:   8650	<- начало 123-пакетного блока данных
Bits:  0 offs: 002453C2 (  430 ) m:    111 d:   9226
Bits:  0 offs: 002477CC (  430 ) m:    112 d:   9226
...
Bits:  0 offs: 0034CC54 (  430 ) m:    228 d:   9226
Bits:  0 offs: 0034F05E (  430 ) m:    229 d:   9226
Bits:  0 offs: 00351692 (  984 ) m:    230 d:   9780
Bits:  0 offs: 00357BDC ( 8462 ) m:    231 d:  25930
Bits:  0 offs: 0035BF66 ( 7300 ) m:    232 d:  17290
Bits:  0 offs: 0035E130 ( 6724 ) m:    233 d:   8650	<- начало следующего блока данных
Bits:  0 offs: 0036053A ( 6724 ) m:    234 d:   9226
Bits:  0 offs: 00362944 ( 6724 ) m:    235 d:   9226
...
Bits:  0 offs: 228E564C (  934 ) m:  61361 d:   9226
Bits:  0 offs: 228E7A56 (  934 ) m:  61362 d:   9226
Bits:  0 offs: 228EA08A ( 1488 ) m:  61363 d:   9780
Bits:  0 offs: 228F05D4 ( 8966 ) m:  61364 d:  25930
Bits:  0 offs: 228F495E ( 7804 ) m:  61365 d:  17290
Bits:  0 offs: 228F6B28 ( 7228 ) m:  61366 d:   8650	<- начало последнего блока данных ( неполного )
Bits:  0 offs: 228F8F32 ( 7228 ) m:  61367 d:   9226
Bits:  0 offs: 228FB33C ( 7228 ) m:  61368 d:   9226
...

Здесь в этой распечатке в первой колонке указано количество несовпадающих бит синхросерии
( то есть 10-байтного заголовка ), во второй колонке - смещение пакета от начала файла,
в третье колонке - сквозной номер пакета внутри файла и в четвертой колонке - длина пакета
в байтах.

Видно, что в основном транспортный поток состоит из пакетов длиной 9226 байт. Периодически
эти пакеты перебиваются группой пакетов с другим длинами, а именно 9780, 25930, 17290 и
8650 байт. Периодичность таких вкраплений по всему файлу строго сохраняется и составляет
123 пакета или 1159544 байта.

Таким образом, можно сказать, что файл состоит из некоторого ( возможно, нецелого )
количества транспортных блоков, а каждый блок включает в себя 119 пакетов длиной 9226 байт,
за которыми следуют по 1 пакету длиной 9780, 25930, 17290 и 8650 байт. Наличие такой
повторяющейся структуры данных легко позволяет выбрать реперную точку для позиционного
отсчета данных. Например, в качестве репера можно выбрать начало первого пакета длиной 9226
байт, идущего после нестандартной четверки пакетов с разными длинами.

Для данного конкретного файла Y3E_08534_230226070855_7860R_MERSI.DAT, рассматриваемого здесь,
можно сказать, что он состоит из 498 полных транспортных блоков, а также первого неполного
блока, содержащего 110 пакетов, и последнего неполного блока, содержащего 120 пакетов.

Анализ данных пакета длиной 9780 байт показал, что внутри этого пакета содержится последняя
строка данных, аналогичная пакету длиной 9226 байт, а также дополнительно 554 байта данных
без явной синхросерии. Поэтому в приведенной ниже таблице Первый полный блок данных обозначен
таким образом.

Полученные сведения изображены на схеме ниже.

Смещение	Название			Длина
-----------------------------------------------------------
0		Заголовок файла			1331906
-----------------------------------------------------------
1331906		Начало транспортного потока	9226 * 110
		Заголовок первого пакета
-----------------------------------------------------------
2346766		Первый полный блок данных	9226 * 120 + 554 + 25930 + 17290 + 8650 = 1159544
3506310		Следующий блок данных		1159544
...
578664880	498-ой полный блок данных	1159544
579824424	Последний блок (неполный)	9226 * 120
580931544	размер файла
-----------------------------------------------------------

2. Структура транспортного блока данных.

Как рассматривалось в пункте 1, так называемый блок данных состоит из 119 пакетов длиной 9226 байт,
а также следующих далее пакетов длиной 9780, 25930, 17290 и 8650 байт, причем пакет длиной 9780
байт содержит последнюю 120-ую строку данных длиной 9226 байт и следующую за этой строкой неизвестную
информацию длиной 554 байт, обозначаемую как DATA2.

------------------------------------------
Блок данных	DATA1		9226 * 120
		DATA2		9780 - 9226 = 554
		DATA3		25930
		DATA4		17290
		DATA5		8650
------------------------------------------
Общая длина			1159544
------------------------------------------

Обозначенные во второй колонке названия имеют символический характер, так как неизвестно, что это
за данные.
Структура данных DATA1 рассматривается в пункте 3. Остальные данные пока не изучались и не
визуализировались. Это было еще и потому, что неизвестна дискретность этих данных. Например,
данные DATA2, за вычетом строки данных 9226 байт и имеющие длину 554 байт, не содержат целого
числа 12-битных отсчетов, а именно 554 / 1.5 = 369.33333333333333333333333333333,
поэтому резонно предположить, что эти данные содержат не 12-битные данные, а какие-то другие,
например 8-битные, 16-битные или 32-битные данные.

3. Структура данных DATA1.

Визуализация пакетов данных DATA1, имеющих длину 9226 байт, позволила выяснить природу этих
данных для некоторых из них. Данные DATA1 в основном состоят из 12-битных отсчетов, так что
каждый пакет DATA1 состоит из ( 9226 - 10 ) / 1.5 = 6144 отсчетов и 10-байтного заголовка.
Это соответствует документации по файлам MERSI, согласно которой такое количество отсчетов
имеет строка данных сканирования повышенного разрешения ( 250 метров ). Визуализация показала,
что в начале каждого блока DATA1 содержится 40 строк ( пакетов ) одного канала повышенного
разрешения, за которым следуют 40 строк ( пакетов ) второго канала повышенного разрешения,
при этом каждый транспортный пакет содержит ровно 1 строку сканирования, соответствующую
1 датчику сканирования из 10. Можно предположить, что один блок данных содержит 4 полных
сканирования по 10 строк каждого из двух каналов повышенного разрешения.
Последние 40 транспортных пакетов DATA1 содержат ИК каналы разрешения 1 км ( 7 каналов ),
а также 90 строк длиной 1536 отсчетов неизвестных данных.

Таким образом, пока что сведения о данных DATA1 выглядят следующим образом.

---------------------------------------------------------------------------------------------------
DATA1		1 канал ( 250 м )		9226 байт * 40 = 6144 отсчетов * 4 скана * 10 строк
		-----------------------------------------------------------------------------------
		2 канал ( 250 м )		9226 байт * 40 = 6144 отсчетов * 4 скана * 10 строк
		-----------------------------------------------------------------------------------
		7 ИК каналов ( 1км )		9226 * 40 = 6144 отсчета * 40 строк =
		+ Неизвестные данные		= 1536 отсчетов * 160 строк =
						= ( 1536 отсчетов * 1 скан * 10 строк ) * 7 каналов +
						+ 1536 * 90 строк неизвестных данных
---------------------------------------------------------------------------------------------------

Неизвестные данные, содержащие в последних 40 транспортных пакетах DATA1, были визуализированы
как и все остальные данные с дискретностью 12 бит. Однако если эти данные содержат маски, то,
возможно, их нужно визуализировать с дискретностью 1 бит, где на каждую точку отведено всего
два значения, то есть 0 или 1. Как показала визуализация, данные сканирования ИК-каналов имеют
дискретность 12 бит, как и данные повышенного разрешения, однако реальный диапазон данных
зачастую укладывается в 10 бит.

4. Структура данных DATA2.

После того, как из нестандартного транспортного пакета DATA2 длиной 9780 байт была исключена
последняя строка сканируемых данных, там остался кусок данных DATA2 размером 554 байта.
Эта структура данных не снабжена синхросерией, а начинается с 24-битного номера блока данных.
Какие-либо другие поля в этой структуре определить пока не удалось. Вероятно, структура содержит
текущее время и дату в неизвестной форме, а также какие-либо геодезические параметры сканировния,
например широту и долготу текущего блока данных.

5. Структура данных DATA3.

Так называемые данные DATA3 находятся после блока сканируемых данных DATA1 ( 120 строк ) и
после специализированного китайского 0-блока DATA2 длиной 554 байта. Они предваряются
обычной сихросерией ( 9 нулей и 0x64 ) и имеют чистую длину 25920 байт. Поскольку все эти
данные совершенно однородны, легко определить, что все они состоят из 12-битных отсчетов
в количестве 17280 = 25920 / 1.5. Визуализация одной строки этих данных говорит о том,
что в строке DATA3 находятся 120 маленьких массивов по 144 отсчета каждый, то есть
17280 отсчетов = 120 строк * 144 отсчета. Совпадение количества массивов DATA3 с количеством
строк DATA1 наводит на мысль о том, что каждый из этих массивов содержит информацию, относящуюся
к одной строке сканируемых данных DATA1.
Каждый из 120 массивов по 144 отсчета содержит слабо изменяемые данные, которые слабо
колеблются вокруг некоторого среднего значения, причем среднее значение для каждого массива
свое, что хорошо видно по цвету полос на картинке ( см. *DATA3_17280.gif ). Слабая изменчивость
наблюдается также и по времени, поскольку практически все 499 строк DATA3, соответствующие
499 блокам данных практически не отличаются друг от друга.

6. Структура данных DATA4.

Так называемые данные DATA4 находятся после строки массивов DATA3. Они предваряются
обычной сихросерией ( 9 нулей и 0x64 ) и имеют чистую длину 17280 байт. Поскольку все эти
данные совершенно однородны, легко определить, что все они состоят из 12-битных отсчетов
в количестве 11520 = 17280 / 1.5. Визуализация одной строки этих данных говорит о том,
что в строке DATA4 находятся 120 маленьких массивов по 96 отсчетов каждый, то есть
11520 отсчетов = 120 строк * 96 отсчетов. Совпадение количества массивов DATA4 с количеством
строк DATA1 наводит на мысль о том, что каждый из этих массивов содержит информацию, относящуюся
к одной строке сканируемых данных DATA1.
Характеристики массивов DATA4 аналогичны характеристикам массивов DATA3. Единственное отличие
заключается в том, что средние значения массивов DATA3 и DATA4, относящиеся к одной и той же
строке данных DATA1, сильно отличаются. Изображение данных DATA4 см. *DATA4_11520.gif.

7. Структура данных DATA5.

Так называемые данные DATA5 находятся после строки массивов DATA4. Они предваряются
обычной сихросерией ( 9 нулей и 0x64 ) и имеют чистую длину 8540 байт. Поскольку все эти
данные совершенно однородны, легко определить, что все они состоят из 12-битных отсчетов
в количестве 5760 = 8640 / 1.5. Визуализация одной строки этих данных говорит о том,
что в строке DATA5 находятся 120 маленьких массивов по 48 отсчетов каждый, то есть
5760 отсчетов = 120 строк * 48 отсчетов. Совпадение количества массивов DATA5 с количеством
строк DATA1 наводит на мысль о том, что каждый из этих массивов содержит информацию, относящуюся
к одной строке сканируемых данных DATA1.
Характеристики массивов DATA5 аналогичны характеристикам массивов DATA3 и DATA4. Единственное
отличие заключается в том, что средние значения массивов DATA5, DATA3 и DATA4, относящиеся к
одной и той же строке данных DATA1, сильно отличаются. Изображение данных DATA5 см. *DATA5_5760.gif.

8. Обновленная структура транспортного блока данных.

На основании полученных данных можно уточнить приведенную выше структуру транспортного блока данных.
--------------------------------------------------------------------------------------------------
Блок данных	DATA1		9226 байт * 120 строк
		DATA2		9780 - 9226 = 554 байта ( 0-блок )
		DATA3		25930 байт = 1.5 байта * 17280 отсчетов => 120 строк * 144 отсчета
		DATA4		17290 байт = 1.5 байта * 11520 отсчетов => 120 строк * 96 отсчетов
		DATA5		8650 байт = 1.5 байта * 5760 отсчетов => 120 строк * 48 отсчетов
--------------------------------------------------------------------------------------------------
Общая длина			1159544 байт
--------------------------------------------------------------------------------------------------

Поскольку других данных в файле MERSI уровня L0 нет, можно предположить, что таблицы калибровки
либо зашиты в DATA2, либо представляют из себя нечто, что может быть получено из массивов
DATA3, DATA4 или DATA5.
